<div class="title-container mt-4">
  <h1 class="text-center title-shadow">ORDER DETAILS: <%= @order.id %></h1>
</div>
<div class="line mb-4"></div>

<div class="order-summary p-4"> <%# Reutilizando o estilo do checkout %>

  <h3 class="mt-4">PRODUCTS IN THIS ORDER</h3>
  <ul class="list-group list-group-flush mb-4">
    <% @order.products.each do |product| %>
      <li class="list-group-item d-flex align-items-center">

        <%# Imagem em miniatura %>
        <% if product.photos.attached? %>
          <%= cl_image_tag product.photos.first.key, class: "order-product-image" %>
        <% else %>
          <%# (Um 'placeholder' caso o produto não tenha foto) %>
          <div class="order-product-image-placeholder"></div>
        <% end %>

        <%# Container para o texto (Nome/Preço) %>
        <div class="flex-grow-1 ms-3">
          <%# Nome como Link %>
          <%= link_to product.name, product_path(product), class: "product-link" %>

          <%# Mostrar o valor do item %>
          <span class="d-block"><%= number_to_currency(product.price, unit: "₿ ") %></span>
        </div>
      </li>
    <% end %>
  </ul>

  <h3 class="mt-4">SHIPPING & SUMMARY</h3>
  <ul class="list-group list-group-flush">
    <li class="list-group-item"><strong>User:</strong> <%= @order.user.full_name %></li>
    <li class="list-group-item">
      <strong>Status:</strong>
      <% if @order.status == "Delivered" %>
        <span class="badge bg-success text-dark"><i class="fas fa-check-circle"></i> Delivered</span>
      <% else %>
        <span class="badge bg-warning text-dark"><i class="fas fa-clock"></i> Processing</span>
      <% end %>
    </li>
    <li class="list-group-item"><strong>Shipped to:</strong> <%= @order.planet %></li>
    <li class="list-group-item"><strong>Address:</strong> <%= @order.address %></li>
  </ul>

  <%# Distinção entre Subtotal, Frete e Total %>
  <%# (É calculado o subtotal e o frete a partir do total) %>
  <%
    subtotal = @order.products.sum(&:price)
    shipping = @order.total - subtotal
  %>

  <div class="order-total-summary mt-4">
    <p>
      <span>Subtotal:</span>
      <span><%= number_to_currency(subtotal, unit: "₿ ") %></span>
    </p>
    <p>
      <span>Shipping (<%= @order.shipping_method %>):</span>
      <span><%= number_to_currency(shipping, unit: "₿ ") %></span>
    </p>
    <p class="total">
      <span>Total:</span>
      <span class="text-neon"><%= number_to_currency(@order.total, unit: "₿ ") %></span>
    </p>
  </div>
</div>

<div class="d-flex justify-content-between align-items-center mt-4">
  <%= link_to 'Back to My Orders', orders_path, class: 'btn btn-secondary' %>

  <%# O Pundit (policy) já garante que só o dono vê essa página, mas no futuro pode-se adicionar uma lógica extra: só pode cancelar se não foi enviado ainda. %>

  <%# LÓGICA DE CANCELAMENTO %>
  <%# Se o status for "Delivered", NÃO mostra o botão de cancelar %>
  <% if @order.status == "Delivered" %>
    <div class="text-success">
      <i class="fas fa-box-open"></i> This order has been delivered.
    </div>
  <% else %>
    <%# Se for "Processing" (ou qualquer outra coisa), permite cancelar %>
    <%= button_to "Cancel Order", order_path(@order),
        method: :delete,
        class: "btn btn-danger",
        form: { data: { turbo_confirm: "Are you sure you want to cancel this order?" } } %>
  <% end %>
</div>
